<?xml version="1.0" encoding="UTF-8"?>
<!-- Generated by Apache ServiceMix Archetype -->
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:cxf="http://camel.apache.org/schema/cxf"
	xmlns:osgi="http://www.springframework.org/schema/osgi" xmlns:osgix="http://www.springframework.org/schema/osgi-compendium"
	xmlns:sql="http://camel.apache.org/schema/cxf" xmlns:ctx="http://www.springframework.org/schema/context"
	xmlns:jaxrs="http://cxf.apache.org/jaxrs" xmlns:prop="http://camel.apache.org/schema/placeholder"
	xsi:schemaLocation="
    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
    http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd
    http://camel.apache.org/schema/cxf http://camel.apache.org/schema/cxf/camel-cxf.xsd 
    http://camel.apache.org/schema/sql http://camel.apache.org/schema/sql/camel-sql.xsd
    http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi.xsd
    http://www.springframework.org/schema/osgi-compendium  http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd
    http://www.springframework.org/schema/context  http://www.springframework.org/schema/context/spring-context.xsd
    http://cxf.apache.org/jaxrs http://cxf.apache.org/schemas/jaxrs.xsd">

	<osgix:cm-properties id="preProps" persistent-id="put.me.in.etc.folder">
		<prop key="externalPort">9213</prop>
		<prop key="internalPort">9202</prop>
		
		<prop key="activemq.brokerURL">tcp://localhost:61616</prop>
        <prop key="activemq.userName">admin</prop>
        <prop key="activemq.password">admin</prop>
        
        <prop key="errorhandler.maximumRedeliveries">3</prop>
        <prop key="errorhandler.redeliveryDelay">10000</prop>
	</osgix:cm-properties>

		<!-- setup JMS connection factory -->
		<bean id="poolConnectionFactory" class="org.apache.activemq.pool.PooledConnectionFactory">
		    <property name="maxConnections" value="8"/>
		    <property name="connectionFactory" ref="jmsConnectionFactory"/>
		</bean>
		 
		<bean id="jmsConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory">
             <property name="brokerURL" value="${activemq.brokerURL}"/>
             <property name="userName" value="${activemq.userName}"/>
             <property name="password" value="${activemq.password}"/>
		</bean>
		 
		<!-- setup spring jms TX manager -->
		<bean id="jmsTransactionManager" class="org.springframework.jms.connection.JmsTransactionManager">
		    <property name="connectionFactory" ref="poolConnectionFactory"/>
		</bean>
		
		<bean id="PROPAGATION_REQUIRED" class="org.apache.camel.spring.spi.SpringTransactionPolicy">
		    <property name="transactionManager" ref="jmsTransactionManager"/>
		    <property name="propagationBehaviorName" value="PROPAGATION_REQUIRED"/>
		</bean>
	
	     <!--Queues-->
	     <bean id="activemq" class="org.apache.activemq.camel.component.ActiveMQComponent">
	        <property name="connectionFactory" ref="poolConnectionFactory"/>
		    <!-- define the jms consumer/producer as transacted -->
		    <property name="transacted" value="true"/>
		    <!-- setup the transaction manager to use -->
		    <!-- if not provided then Camel will automatic use a JmsTransactionManager, however if you
		         for instance use a JTA transaction manager then you must configure it -->
		    <property name="transactionManager" ref="jmsTransactionManager"/>
	     </bean>
     
	<ctx:property-placeholder properties-ref="preProps" />
	
	
	<camelContext xmlns="http://camel.apache.org/schema/spring" trace="true">
    <propertyPlaceholder location="ref:preProps" id="properties"/>
    <errorHandler type="DeadLetterChannel" deadLetterUri="activemq:queue:myTestQueue.DLQ" id="errorHandler">
        <redeliveryPolicy maximumRedeliveries="{{errorhandler.maximumRedeliveries}}" redeliveryDelay="{{errorhandler.redeliveryDelay}}" retryAttemptedLogLevel="INFO" logRetryAttempted="true" logRetryStackTrace="true"/>
    </errorHandler>
    <route id="write.queue">
        <from uri="timer:foo?period=10000"/>
        <transform>
            <simple>Writing message</simple>
        </transform>
        <to uri="log:log.write.queue?showAll=true"/>
        <to uri="activemq:queue:myTestQueue"/>
    </route>
    <route id="read.queue">
        <from uri="activemq:queue:myTestQueue"/>
        <transacted/>
        <to uri="bean:someProcessor?method=process"/>
        <to uri="log:log.read.queue?showAll=true"/>
        <to uri="activemq:queue:myOutQueue"/>
    </route>
</camelContext>
	<bean id="someProcessor" class="com.mycompany.test.TestResponse"/>
</beans>